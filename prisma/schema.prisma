// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PrivacyLevel {
  PUBLIC
  FRIENDS
  PRIVATE
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

enum MediaType {
  NONE
  IMAGE
  VIDEO
}

enum NotificationType {
  FRIEND_REQUEST
  FRIEND_ACCEPT
  POST_LIKE
  POST_COMMENT
  MESSAGE
  FOLLOW
  POST_REPOST
}

enum ReactionType {
  LOVE
  APPLAUD
  SALUTE
  SHINE
}

model User {
  id            String        @id @default(uuid())
  email         String        @unique
  password      String?       // Hashed password (null for OAuth users)
  emailVerified Boolean       @default(false)
  cognitoId     String?       @unique
  username      String        @unique
  displayName   String
  avatar        String?
  bio           String?       @db.Text
  profession    String?
  location      String?
  privacyLevel  PrivacyLevel  @default(PUBLIC)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  posts                Post[]
  postLikes            PostLike[]
  postReactions        PostReaction[]
  savedPosts           SavedPost[]
  reposts              Repost[]
  comments             Comment[]
  sentFriendRequests   Friendship[]     @relation("SentFriendRequests")
  receivedFriendRequests Friendship[]   @relation("ReceivedFriendRequests")
  followers            Follow[]         @relation("UserFollowers")
  following            Follow[]         @relation("UserFollowing")
  sentMessages         Message[]        @relation("SentMessages")
  conversations1       Conversation[]   @relation("Participant1")
  conversations2       Conversation[]   @relation("Participant2")
  notifications        Notification[]   @relation("NotificationRecipient")
  triggeredNotifications Notification[] @relation("NotificationActor")

  @@index([email])
  @@index([username])
  @@index([cognitoId])
}

model Friendship {
  id          String           @id @default(uuid())
  requesterId String
  addresseeId String
  status      FriendshipStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  requester User @relation("SentFriendRequests", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee User @relation("ReceivedFriendRequests", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([requesterId])
  @@index([addresseeId])
  @@index([status])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Post {
  id           String       @id @default(uuid())
  authorId     String
  content      String       @db.Text
  mediaUrls    String[]     @default([])
  mediaType    MediaType    @default(NONE)
  privacyLevel PrivacyLevel @default(PUBLIC)
  likeCount    Int          @default(0)
  commentCount Int          @default(0)
  repostCount  Int          @default(0)
  saveCount    Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  author       User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  likes        PostLike[]
  reactions    PostReaction[]
  saves        SavedPost[]
  reposts      Repost[]
  comments     Comment[]

  @@index([authorId])
  @@index([createdAt])
  @@index([privacyLevel])
}

model PostLike {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model PostReaction {
  id        String       @id @default(uuid())
  postId    String
  userId    String
  type      ReactionType
  variant   String       @default("default") // Stores emoji variant like "black", "brown", "medium", "light", "yellow"
  createdAt DateTime     @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, type])
  @@index([postId])
  @@index([userId])
}

model SavedPost {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

model Repost {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  comment   String?
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(uuid())
  postId    String
  authorId  String
  content   String   @db.Text
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post     Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@index([createdAt])
}

model Conversation {
  id             String    @id @default(uuid())
  participant1Id String
  participant2Id String
  lastMessageAt  DateTime  @default(now())
  createdAt      DateTime  @default(now())

  participant1 User      @relation("Participant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User      @relation("Participant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages     Message[]

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([lastMessageAt])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderId       String
  content        String   @db.Text
  read           Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  actorId   String?
  postId    String?
  message   String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user  User  @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  actor User? @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model VerificationToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  type      String   // 'email-verification' or 'password-reset'
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String  // 'oauth' or 'credentials'
  provider          String  // 'google', 'linkedin', 'credentials'
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model LoginAttempt {
  id          String   @id @default(uuid())
  identifier  String   // email or IP address
  successful  Boolean
  attemptedAt DateTime @default(now())

  @@index([identifier])
  @@index([attemptedAt])
}
